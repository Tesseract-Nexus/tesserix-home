"use client";

import { useApi, apiFetch } from './use-api';

export interface TicketComment {
  id: string;
  content: string;
  isInternal?: boolean;
  author?: {
    name: string;
    email: string;
    role: string;
  };
  created_by?: string;
  created_by_name?: string;
  created_by_email?: string;
  created_at?: string;
}

export interface Ticket {
  id: string;
  ticket_number?: string;
  tenant_id?: string;
  title: string;
  description?: string;
  type?: string;
  status: string;
  priority: string;
  tags?: string[];
  created_by?: string;
  created_by_name?: string;
  created_by_email?: string;
  created_at?: string;
  updated_at?: string;
  due_date?: string;
  assignees?: Array<{ id: string; name: string; email: string }>;
  comments?: TicketComment[];
  // Populated by joining with tenant data
  tenant_name?: string;
}

export interface TicketsResponse {
  data: Ticket[];
  total: number;
  page: number;
  pageSize?: number;
  totalPages?: number;
  hasNext?: boolean;
  hasPrevious?: boolean;
}

interface TicketFilters {
  status?: string;
  priority?: string;
  search?: string;
  page?: number;
  limit?: number;
}

/**
 * Hook to fetch ticket list with filtering and pagination.
 */
export function useTickets(filters: TicketFilters = {}) {
  const params = new URLSearchParams();
  if (filters.page) params.set('page', String(filters.page));
  if (filters.limit) params.set('limit', String(filters.limit));
  if (filters.status && filters.status !== 'all') params.set('status', filters.status);
  if (filters.priority && filters.priority !== 'all') params.set('priority', filters.priority);
  if (filters.search) params.set('search', filters.search);

  const queryString = params.toString();
  const url = `/api/tickets${queryString ? `?${queryString}` : ''}`;

  return useApi<TicketsResponse>(url);
}

/**
 * Hook to fetch a single ticket by ID.
 */
export function useTicket(id: string | null) {
  return useApi<Ticket>(id ? `/api/tickets/${id}` : null);
}

/**
 * Update ticket status.
 */
export async function updateTicketStatus(id: string, status: string) {
  return apiFetch(`/api/tickets/${id}/status`, {
    method: 'PUT',
    body: JSON.stringify({ status }),
  });
}

/**
 * Add a comment to a ticket.
 */
export async function addTicketComment(id: string, content: string, isInternal = false) {
  return apiFetch(`/api/tickets/${id}/comments`, {
    method: 'POST',
    body: JSON.stringify({ content, isInternal }),
  });
}

/**
 * Update a ticket's details.
 */
export async function updateTicket(id: string, data: Partial<Ticket>) {
  return apiFetch(`/api/tickets/${id}`, {
    method: 'PUT',
    body: JSON.stringify(data),
  });
}
